---
import Layout from '../layouts/Layout.astro';
import { getCollection } from 'astro:content';

// Get featured event
const events = await getCollection('events');
const featuredEvent = events.find(event => event.data.featured) || events[0];

// Get trainer info
const trainer = await getCollection('trainer');
const trainerInfo = trainer[0];
const trainerData = trainer[0]?.data;

// Get contact info
import contactData from '../content/settings/contact.json';

// Format date range
function formatDateRange(startStr, endStr) {
  const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const s = new Date(startStr);
  const e = endStr ? new Date(endStr) : null;
  if (!e || s.toDateString() === e.toDateString()) {
    return `${s.getDate()} ${months[s.getMonth()]} ${s.getFullYear()}`;
  }
  const sameMonth = s.getMonth() === e.getMonth() && s.getFullYear() === e.getFullYear();
  if (sameMonth) return `${s.getDate()} - ${e.getDate()} ${months[s.getMonth()]} ${s.getFullYear()}`;
  return `${s.getDate()} ${months[s.getMonth()]} - ${e.getDate()} ${months[e.getMonth()]} ${s.getFullYear()}`;
}

const dateStr = featuredEvent ? formatDateRange(featuredEvent.data.startDate, featuredEvent.data.endDate) : '';
---

<Layout title="HabitatRoot - Storytelling and Postural Awareness Course">
  <!-- Hero Section -->
  <section class="hero-section bg-gradient-to-br from-blue-50 to-gray-50">
    <div class="container-custom text-center">
      <div class="max-w-4xl mx-auto">
        <h1 class="text-5xl md:text-6xl font-bold text-gray-900 mb-6">
          {featuredEvent?.data.title || "Storytelling and Postural Awareness Course"}
        </h1>
        <p class="text-xl md:text-2xl text-gray-600 mb-8 leading-relaxed">
          {featuredEvent?.data.intro || "The first immersive communication and posture course in Romania"}
        </p>
        <div class="flex flex-col sm:flex-row gap-4 justify-center">
          <a href="#program" class="btn-primary text-lg">Program details</a>
          <a href="#register" class="btn-secondary text-lg">Book course</a>
        </div>
      </div>
    </div>
  </section>

  <!-- Event Details -->
  {featuredEvent && (
    <section id="program" class="py-20 bg-white">
      <div class="container-custom">
        <div class="max-w-6xl mx-auto">
          <div class="text-center mb-16">
            <div class="flex flex-wrap justify-center gap-8 text-lg mb-8">
              <div class="flex items-center gap-2 text-gray-600">
                <span class="text-2xl">üìÖ</span>
                <span>{new Date(featuredEvent.data.startDate).toLocaleDateString('en-US', {
                  day: 'numeric',
                  month: 'short',
                  year: 'numeric'
                })} - {new Date(featuredEvent.data.endDate).toLocaleDateString('en-US', {
                  day: 'numeric',
                  month: 'short',
                  year: 'numeric'
                })}</span>
              </div>
              <div class="flex items-center gap-2 text-gray-600">
                <span class="text-2xl">üìç</span>
                <span>{featuredEvent.data.locationName}</span>
              </div>
              <div class="flex items-center gap-2 text-gray-600">
                <span class="text-2xl">üë®‚Äçüè´</span>
                <span>{trainerInfo?.data.name}</span>
              </div>
            </div>
          </div>

          <div class="prose prose-lg max-w-none mb-16">
            <p class="text-xl leading-relaxed text-gray-700 text-center mb-12">
              {featuredEvent.data.intro}
            </p>

            <h2 class="text-3xl font-bold text-center mb-12 text-gray-900">Course program</h2>

            <div class="grid md:grid-cols-2 gap-8">
              {featuredEvent.data.program?.map((day: any) => (
                <div class="card">
                  <h3 class="text-xl font-bold text-gray-900 mb-4">{day.dayTitle}</h3>
                  <p class="text-gray-600 leading-relaxed">{day.content}</p>
                </div>
              ))}
            </div>
          </div>
        </div>
      </div>
    </section>
  )}

  <!-- Location Section -->
  <section id="location" class="py-20 bg-gray-50">
    <div class="container-custom">
      <div class="max-w-4xl mx-auto text-center">
        <h2 class="text-4xl font-bold mb-12 text-gray-900">Course location</h2>
        {featuredEvent && (
          <div class="card max-w-2xl mx-auto">
            <h3 class="text-2xl font-bold text-gray-900 mb-4">{featuredEvent.data.locationName}</h3>
            <p class="text-lg text-gray-600 mb-6">A beautiful retreat location perfect for learning and growth.</p>
            <a href={featuredEvent.data.locationUrl} class="btn-primary inline-block" target="_blank">View on map</a>
          </div>
        )}
      </div>
    </div>
  </section>

  <!-- Pricing Section -->
  <section id="pricing" class="py-20 bg-white">
    <div class="container-custom">
      <div class="max-w-4xl mx-auto">
        <h2 class="text-4xl font-bold text-center mb-16 text-gray-900">Course Pricing</h2>

        {featuredEvent && (
          <div class="grid md:grid-cols-2 gap-8 mb-8">
            {featuredEvent.data.pricing?.map((option: any) => (
              <div class="card text-center">
                <h3 class="text-2xl font-bold text-gray-900 mb-4">{option.label}</h3>
                <p class="text-4xl font-bold text-blue-600 mb-6">{option.price}</p>
                <a href="#register" class="btn-primary">Book now</a>
              </div>
            ))}
          </div>
        )}

        <div class="text-center">
          <p class="text-sm text-gray-500">* payment in 2 installments option, please contact us directly</p>
        </div>
      </div>
    </div>
  </section>

  <!-- Host & Special Guest -->
  {(trainerData || (featuredEvent && featuredEvent.data.specialGuests?.length)) && (
    <section class="container mx-auto px-4 py-12">
      <div class="grid md:grid-cols-2 gap-8">
        {trainerData && (
          <div class="card bg-base-100 shadow">
            <div class="card-body">
              <h3 class="card-title">Meet your host {trainerData.name}</h3>
              <blockquote class="italic">‚Äú{trainerData.story}‚Äù</blockquote>
            </div>
          </div>
        )}
        {featuredEvent?.data.specialGuests?.length > 0 && (
          <div class="card bg-base-100 shadow">
            <div class="card-body">
              <h3 class="card-title">Special guest: {featuredEvent.data.specialGuests[0].name}</h3>
              <p>‚Äú{featuredEvent.data.specialGuests[0].bio}‚Äù</p>
            </div>
          </div>
        )}
      </div>
    </section>
  )}

  <!-- Register section -->
  {featuredEvent && (
    <section id="register" class="container mx-auto px-4 py-12">
      <h2 class="text-3xl font-bold mb-6">Register</h2>
      <div class="card bg-base-100 shadow">
        <div class="card-body">
          <p class="mb-4 text-sm opacity-80">Course: {featuredEvent.data.title} ‚Ä¢ Dates: {dateStr} ‚Ä¢ Location: {featuredEvent.data.locationName}</p>
          <form class="grid gap-4 max-w-2xl">
            <input name="full_name" class="input input-bordered" placeholder="Full name" required />
            <input name="phone" class="input input-bordered" placeholder="Phone number" required />
            <input name="email" type="email" class="input input-bordered" placeholder="Email address" required />
            <textarea name="interest" class="textarea textarea-bordered" placeholder="Why are you interested in this course and what are you hoping to explore or learn?" required></textarea>
            <div class="form-control">
              <label class="label"><span class="label-text">Preferred accommodation</span></label>
              <select name="accommodation" class="select select-bordered">
                <option value="double">Double room</option>
                <option value="single">Single room</option>
              </select>
              <label class="label"><span class="label-text-alt">Single room comes at a higher rate.</span></label>
            </div>
            <input name="social_url" class="input input-bordered" placeholder="Instagram/LinkedIn profile URL" required />
            <div class="form-control">
              <label class="label"><span class="label-text">Interested in participating in the final show with a partner?</span></label>
              <div class="flex gap-4">
                <label class="label cursor-pointer"><span class="label-text mr-2">Yes</span><input type="radio" name="final_show_partner" value="yes" class="radio" required /></label>
                <label class="label cursor-pointer"><span class="label-text mr-2">No</span><input type="radio" name="final_show_partner" value="no" class="radio" required /></label>
              </div>
            </div>
            <textarea name="notes" class="textarea textarea-bordered" placeholder="Anything else you'd like to share?" required></textarea>
            <p class="text-sm opacity-80">To reserve your spot, we ask for a 50% deposit; full payment is due 5 working days before the course.</p>
            <button class="btn btn-primary">Book now</button>
          </form>
        </div>
      </div>
    </section>
  )}



  <script>
    const ids = ['program','location','pricing','register'];
    const link = id => document.querySelector(`a[href="#${id}"]`);
    const obs = new IntersectionObserver((entries)=>{
      entries.forEach(e=>{
        const a = link(e.target.id);
        if (a) a.classList.toggle('btn-active', e.isIntersecting);
      });
    }, { rootMargin: '-40% 0px -55% 0px', threshold: 0.01 });
    ids.forEach(id => { const el = document.getElementById(id); if (el) obs.observe(el); });
  </script>
</Layout>
